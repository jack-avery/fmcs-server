---
- name: Setup
  ansible.builtin.include_tasks: setup.yml

- name: Find expired backups
  ansible.builtin.find:
    paths: "{{ role_path }}/files/{{ inventory_hostname }}"
    age: "{{ delete_backups_after_days }}d"
    recurse: yes
  register: old_backups
  delegate_to: localhost

- name: Delete expired backups
  ansible.builtin.file:
    path: "{{ item.path }}" 
    state: absent
  with_items: "{{ old_backups.files }}"
  delegate_to: localhost

- name: Inform backup (might lag)
  ignore_errors: true
  rcon:
    address: "{{ ansible_host }}"
    port: "{{ item.port + 1}}"
    password: "{{ item.secrets.rcon_pass }}"
    command: "say Backup triggered, server might lag."
  loop: "{{ targets.instances }}"
  timeout: 10
  delegate_to: localhost

- name: Turn off automatic saving
  ignore_errors: true
  rcon:
    address: "{{ ansible_host }}"
    port: "{{ item.port + 1 }}"
    password: "{{ item.secrets.rcon_pass }}"
    command: "save-off"
  loop: "{{ targets.instances }}"
  timeout: 10
  delegate_to: localhost

- name: (Attempt to?) save current world state
  ignore_errors: true
  rcon:
    address: "{{ ansible_host }}"
    port: "{{ item.port + 1 }}"
    password: "{{ item.rcon_pass }}"
    command: "save-all"
  loop: "{{ targets.instances }}"
  timeout: 10
  delegate_to: localhost

- name: Create root backup directory
  ansible.builtin.file:
    path: ~/backups
    state: directory
    mode: 0755

- name: Create remote backup directories
  ansible.builtin.file:
    path: ~/backups/{{ item.name }}
    state: directory
    mode: 0755
  loop: "{{ targets.instances }}"

- name: Create local backup directories
  ansible.builtin.file:
    path: "{{ role_path }}/files/{{ inventory_hostname }}"
    state: directory
    mode: 0755
  delegate_to: localhost

- name: Get date for file
  shell: date +%d-%m-%y_%H-%M
  register: date

- name: Create backups
  ansible.builtin.archive:
    path: ~/{{ item.name }}/world
    dest: ~/backups/{{ item.name }}/{{ date.stdout_lines.0 }}.tar.gz
  loop: "{{ targets.instances }}"

- name: Copy backups to local
  ansible.posix.synchronize:
    mode: pull
    src: ~/backups/
    dest: "{{ role_path }}/files/{{ inventory_hostname }}"

- name: Delete backups on remote for space
  ansible.builtin.file:
    state: absent
    path: ~/backups/{{ item.name }}
  loop: "{{ targets.instances }}"

- name: Turn on automatic saving
  ignore_errors: true
  rcon:
    address: "{{ ansible_host }}"
    port: "{{ item.port + 1 }}"
    password: "{{ item.secrets.rcon_pass }}"
    command: "save-on"
  loop: "{{ targets.instances }}"
  timeout: 10
  delegate_to: localhost

- name: Inform backup complete
  ignore_errors: true
  rcon:
    address: "{{ ansible_host }}"
    port: "{{ item.port + 1 }}"
    password: "{{ item.secrets.rcon_pass }}"
    command: "say Backup completed."
  loop: "{{ targets.instances }}"
  timeout: 10
  delegate_to: localhost
